<?xml version="1.0" encoding="UTF-8"?>
<templates id="templates" xml:space="preserve">
  <t t-name="ths_medical_pos.EncounterSelectionPopup">
    <Dialog title="props.title">
      <!-- Encounters grid layout - 4 per row with proper spacing -->
        <div class="container-fluid">
        <div class="row g-3" style="max-height: 500px; overflow-y: auto;">
          <!-- FIXED: Use encounters getter to access cleaned data -->
            <t t-foreach="encounters" t-as="encounter" t-key="encounter.id">
            <!-- Each encounter card takes 3 columns (4 per row on large screens) -->
                <div class="col-lg-3 col-md-4 col-sm-6 col-12">
              <div class="card h-100 encounter-card"
                   t-attf-class="state-{{ encounter.state }}"
                   style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 8px; transition: all 0.2s ease-in-out;"
                   t-on-click="() => this.confirmSelection(encounter)"
                   onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#007bff';"
                   onmouseout="this.style.boxShadow='none'; this.style.borderColor='#dee2e6';">

                <div class="card-body p-3">
                  <!-- Encounter name and date header -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title text-primary fw-bold mb-0" style="font-size: 0.95rem;">
                      <t t-esc="encounter.name"/>
                    </h6>
                        <small class="text-muted" style="font-size: 0.8rem;">
                      <t t-esc="encounter.encounter_date"/>
                    </small>
                  </div>

                    <!-- Partner information with partner-info div name -->
                    <div class="mb-2 partner-info" name="partner-info">
                    <div class="d-flex align-items-center">
                      <i class="fa fa-user me-2 text-secondary" style="width: 14px;"/>
                        <strong style="font-size: 0.9rem;">
                        <t t-if="encounter.partner_id" t-esc="encounter.partner_id[1]"/>
                            <t t-else="">No Partner</t>
                      </strong>
                    </div>
                  </div>

                    <!-- Patient information with FIXED unique keys -->
                    <t t-if="encounter.patient_ids and encounter.patient_ids.length">
                    <div class="mb-2">
                      <div class="d-flex align-items-start">
                        <i class="fa fa-users me-2 text-secondary mt-1" style="width: 14px;"/>
                          <div style="flex: 1;">
                          <small class="text-muted" style="font-size: 0.8rem;">Patients: </small>
                              <!-- CRITICAL FIX: Use array index as key to prevent duplicates -->
                              <span style="font-size: 0.9rem; font-weight: normal;">
                            <t t-foreach="encounter.patient_ids" t-as="patient" t-key="patient_index">
                              <t t-if="patient and patient.length >= 2" t-esc="patient[1]"/>
                                <t t-elif="patient" t-esc="patient"/>
                                <t t-else="">Unknown Patient</t>
                                <t t-if="!patient_last">, </t>
                            </t>
                          </span>
                        </div>
                      </div>
                    </div>
                  </t>

                    <!-- Practitioner information -->
                    <t t-if="encounter.practitioner_id">
                    <div class="mb-2">
                      <div class="d-flex align-items-center">
                        <i class="fa fa-user-md me-2 text-secondary" style="width: 14px;"/>
                          <small style="font-size: 0.85rem;">
                          <span class="text-muted">Dr. </span>
                              <span t-esc="encounter.practitioner_id[1]"/>
                        </small>
                      </div>
                    </div>
                  </t>

                    <!-- Room information -->
                    <t t-if="encounter.room_id">
                    <div class="mb-2">
                      <div class="d-flex align-items-center">
                        <i class="fa fa-home me-2 text-secondary" style="width: 14px;"/>
                          <small style="font-size: 0.85rem;">
                          <span class="text-muted">Room: </span>
                              <span t-esc="encounter.room_id[1]"/>
                        </small>
                      </div>
                    </div>
                  </t>

                    <!-- State badge at bottom -->
                    <div class="d-flex justify-content-end mt-2">
                    <span t-attf-class="badge {{ encounter.state === 'done' ? 'bg-success' : encounter.state === 'in_progress' ? 'bg-primary' : 'bg-secondary' }}"
                          style="font-size: 0.75rem;">
                      <t t-esc="encounter.state"/>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </t>

            <!-- No encounters message -->
            <div t-if="!encounters.length" class="col-12">
            <div class="text-center p-4 text-muted">
              <i class="fa fa-info-circle fa-2x mb-2"/>
                <p>No medical encounters found</p>
            </div>
          </div>
        </div>
      </div>

        <!-- Footer with cancel button -->
        <t t-set-slot="footer">
        <button class="btn btn-secondary" t-on-click="cancel">
          <i class="fa fa-times me-1"/>
            Cancel
        </button>
      </t>
    </Dialog>
  </t>
</templates>
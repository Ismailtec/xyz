<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Calendar Event Form View Extension for Medical Fields -->
        <record id="view_calendar_event_form_medical" model="ir.ui.view">
            <field name="name">calendar.event.form.medical</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="calendar.view_calendar_event_form"/>
            <field name="arch" type="xml">
                <!-- Add medical fields to the main form -->
                <xpath expr="//field[@name='partner_ids']" position="after">
                    <group name="medical_info" string="Medical Information"
                           attrs="{'invisible': [('ths_patient_id', '=', False)]}">
                        <field name="ths_patient_id"
                               domain="[('ths_partner_type_id.name', '=', 'Pet')]"
                               options="{'no_create': True}"/>
                        <field name="ths_practitioner_id"
                               domain="[('ths_is_medical', '=', True)]"
                               options="{'no_create': True}"/>
                        <field name="ths_room_id"
                               domain="[('active', '=', True)]"
                               options="{'no_create': True}"/>
                        <field name="ths_status"/>
                        <field name="ths_is_walk_in"/>
                        <field name="appointment_type_id" options="{'no_create': True}"/>
                    </group>
                </xpath>

                <!-- Add reason for visit field -->
                <xpath expr="//field[@name='description']" position="before">
                    <field name="ths_reason_for_visit"
                           attrs="{'invisible': [('ths_patient_id', '=', False)]}"/>
                </xpath>

                <!-- Add medical status in header -->
                <xpath expr="//field[@name='recurrency']" position="before">
                    <field name="ths_status" widget="statusbar"
                           statusbar_visible="scheduled,confirmed,checked_in,in_progress,completed,billed"
                           attrs="{'invisible': [('ths_patient_id', '=', False)]}"/>
                </xpath>
            </field>
        </record>

        <!-- Calendar Event Tree View Extension -->
        <record id="view_calendar_event_tree_medical" model="ir.ui.view">
            <field name="name">calendar.event.tree.medical</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="calendar.view_calendar_event_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_ids']" position="after">
                    <field name="ths_patient_id" optional="hide"/>
                    <field name="ths_practitioner_id" optional="hide"/>
                    <field name="ths_status" optional="show"/>
                </xpath>
            </field>
        </record>

        <!-- Medical Appointments Calendar View -->
        <record id="view_calendar_event_calendar_medical" model="ir.ui.view">
            <field name="name">calendar.event.calendar.medical</field>
            <field name="model">calendar.event</field>
            <field name="arch" type="xml">
                <calendar string="Medical Appointments"
                          date_start="start"
                          date_stop="stop"
                          color="ths_practitioner_id"
                          quick_create="0"
                          event_open_popup="1">
                    <field name="display_name"/>
                    <field name="ths_patient_id"/>
                    <field name="ths_practitioner_id"/>
                    <field name="ths_status"/>
                    <field name="partner_id"/>
                </calendar>
            </field>
        </record>

        <!-- Medical Appointments Action -->
        <record id="action_medical_appointments" model="ir.actions.act_window">
            <field name="name">Medical Appointments</field>
            <field name="res_model">calendar.event</field>
            <field name="view_mode">calendar,tree,form</field>
            <field name="domain">[('ths_patient_id', '!=', False)]</field>
            <field name="context">{
                'default_ths_status': 'scheduled',
                'search_default_future': 1,
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Schedule a new medical appointment
                </p>
                <p>
                    Medical appointments link patients with practitioners and can be
                    converted to medical encounters for billing and record keeping.
                </p>
            </field>
        </record>

        <!-- Medical Appointments Menu -->
        <menuitem id="menu_medical_appointments"
                  name="Appointments"
                  parent="point_of_sale.menu_point_of_sale"
                  action="action_medical_appointments"
                  sequence="15"/>

        <!-- Search View for Medical Appointments -->
        <record id="view_calendar_event_search_medical" model="ir.ui.view">
            <field name="name">calendar.event.search.medical</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="calendar.view_calendar_event_search"/>
            <field name="arch" type="xml">
                <xpath expr="//search" position="inside">
                    <field name="ths_patient_id"/>
                    <field name="ths_practitioner_id"/>
                    <field name="ths_room_id"/>
                    <separator/>
                    <filter name="medical_only" string="Medical Appointments"
                            domain="[('ths_patient_id', '!=', False)]"/>
                    <filter name="today_medical" string="Today's Medical"
                            domain="[('ths_patient_id', '!=', False),
                                   ('start', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))),
                                   ('start', '&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59)))]"/>
                    <filter name="future" string="Future Appointments"
                            domain="[('start', '&gt;=', datetime.datetime.now())]"/>
                    <separator/>
                    <filter name="scheduled" string="Scheduled"
                            domain="[('ths_status', '=', 'scheduled')]"/>
                    <filter name="in_progress" string="In Progress"
                            domain="[('ths_status', '=', 'in_progress')]"/>
                    <filter name="completed" string="Completed"
                            domain="[('ths_status', '=', 'completed')]"/>
                    <separator/>
                    <group expand="0" string="Group By">
                        <filter string="Practitioner" name="group_practitioner"
                                context="{'group_by': 'ths_practitioner_id'}"/>
                        <filter string="Status" name="group_status"
                                context="{'group_by': 'ths_status'}"/>
                        <filter string="Room" name="group_room"
                                context="{'group_by': 'ths_room_id'}"/>
                        <filter string="Date" name="group_date"
                                context="{'group_by': 'start:day'}"/>
                    </group>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
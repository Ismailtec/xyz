<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Enhanced Pet/Pet Owner Form View -->
    <record id="view_partner_form_inherit_ths_vet" model="ir.ui.view">
        <field name="name">res.partner.form.inherit.ths.vet</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="ths_base.view_partner_form_inherit_ths_base"/>
        <field name="arch" type="xml">

            <!-- Add computed flags for form logic -->
            <xpath expr="//sheet" position="inside">
                <field name="is_pet" invisible="1"/>
                <field name="is_pet_owner" invisible="1"/>
            </xpath>

            <!-- Pet Owner Selection (Prominent for Pets) -->
            <xpath expr="//div[hasclass('d-inline-block')]" position="after">
                <div class="alert alert-primary mb-3" role="alert" invisible="not is_pet">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="ths_pet_owner_id" class="fw-bold">
                                <i class="fa fa-user me-2" title="Pet Owner Icon"/>Pet Owner (Billing Responsible)
                            </label>
                            <field name="ths_pet_owner_id"
                                   required="is_pet"
                                   domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"
                                   options="{'no_open': True, 'no_create': True, 'no_quick_create': True}"
                                   placeholder="Select the pet owner..."
                                   help="Pet owner responsible for billing and medical decisions"/>
                        </div>
                        <div class="col-md-6">
                            <label for="parent_id" class="fw-bold">
                                <i class="fa fa-sitemap me-2" title="Parent Contact Icon"/>Parent Contact
                            </label>
                            <field name="parent_id" readonly="1"
                                   help="Automatically set from pet owner"/>
                        </div>
                    </div>
                </div>
            </xpath>

            <!-- Replace standard contact fields with pet/owner specific sections -->
            <xpath expr="//sheet//group//group[2]" position="replace">

                <!-- Pet Information Section -->
                <group string="Pet Information" name="pet_info" invisible="not is_pet">
                    <field name="ths_species_id"
                           required="is_pet"
                           options="{'no_create': True, 'no_quick_create': True}"
                           placeholder="e.g., Dog, Cat, Bird..."/>
                    <field name="ths_breed_id"
                           options="{'no_create': True, 'no_quick_create': True}"
                           placeholder="e.g., Golden Retriever, Persian..."/>
                    <field name="ths_dob" string="Date of Birth" widget="date"/>
                    <field name="gender" widget="radio" options="{'horizontal': true}"/>
                    <field name="is_neutered_spayed" widget="boolean_toggle"/>
                </group>

                <!-- Pet Health & ID Section -->
                <group string="Health &amp; Identification" name="pet_health" invisible="not is_pet">
                    <field name="ths_microchip" placeholder="e.g., 982000123456789"/>
                    <field name="ths_insurance_number" placeholder="Insurance policy number"/>
                    <field name="ths_emergency_contact"
                           domain="[('ths_partner_type_id.name', '=', 'Pet Owner'), ('id', '!=', ths_pet_owner_id)]"
                           options="{'no_create': True, 'no_quick_create': True}"/>
                    <field name="ths_deceased" widget="boolean_toggle"/>
                    <field name="ths_deceased_date" invisible="not ths_deceased" widget="date"/>
                </group>

                <!-- Pet Owner Contact Information -->
                <group string="Contact Information" name="owner_info" invisible="is_pet">
                    <field name="function" placeholder="e.g., Manager"/>
                    <field name="phone" widget="phone"/>
                    <field name="mobile" widget="phone"/>
                    <field name="user_id" string="Account Manager"
                           domain="[('share', '=', False)]"/>
                    <field name="title" options="{'no_open': True, 'no_create': True}"/>
                    <field name="lang"/>
                    <field name="category_id" widget="many2many_tags"
                           options="{'color_field': 'color', 'no_create_edit': True}"/>
                </group>
            </xpath>

            <!-- Hide company fields for pets -->
            <xpath expr="//field[@name='is_company']" position="attributes">
                <attribute name="invisible">is_pet</attribute>
            </xpath>
            <xpath expr="//field[@name='vat']" position="attributes">
                <attribute name="invisible">is_pet</attribute>
            </xpath>

            <!-- Add Smart Buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Pets Count for Pet Owners -->
                <button class="oe_stat_button"
                        type="object"
                        name="action_view_partner_pets"
                        icon="fa-paw"
                        invisible="not is_pet_owner or ths_pet_count == 0">
                    <field name="ths_pet_count" widget="statinfo" string="Pets"/>
                </button>

                <!-- Medical History for Pets -->
                <button class="oe_stat_button"
                        type="object"
                        name="action_view_medical_history"
                        icon="fa-stethoscope"
                        invisible="not is_pet">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Medical</span>
                        <span class="o_stat_text">History</span>
                    </div>
                </button>

                <!-- Appointments for Both -->
                <button class="oe_stat_button"
                        type="object"
                        name="action_view_appointments"
                        icon="fa-calendar"
                        invisible="not is_pet and not is_pet_owner">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Appointments</span>
                    </div>
                </button>
            </xpath>

            <!-- Add Notebook Pages -->
            <xpath expr="//notebook" position="inside">

                <!-- Pets Management Tab for Pet Owners -->
                <page string="Pets" name="owner_pets" invisible="not is_pet_owner">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info" role="status">
                                <i class="fa fa-info-circle me-2" title="Information Icon"/>
                                <strong>Pet Management:</strong>
                                All pets listed here are available for appointments and billing under this owner's
                                account.
                                Use the "Add a line" button to register new pets.
                            </div>
                        </div>
                    </div>

                    <field name="ths_pet_ids"
                           context="{'default_ths_pet_owner_id': id, 'default_parent_id': id, 'show_pet_owner': False}">
                        <list editable="bottom" create="true" delete="true">
                            <field name="name" string="Pet Name" required="1"/>
                            <field name="ths_species_id" required="1"/>
                            <field name="ths_breed_id"/>
                            <field name="gender"/>
                            <field name="ths_dob" widget="date"/>
                            <field name="is_neutered_spayed" widget="boolean_toggle"/>
                            <field name="ths_microchip"/>
                            <field name="ths_deceased" widget="boolean_toggle"/>
                            <field name="ths_deceased_date" invisible="1"/>
                            <button name="action_view_medical_history"
                                    type="object"
                                    string="History"
                                    icon="fa-stethoscope"
                                    class="btn btn-sm btn-link"/>
                        </list>
                    </field>
                </page>

                <!-- Medical Summary Tab for Pets -->
                <page string="Medical Summary" name="pet_medical" invisible="not is_pet">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-success" role="status">
                                <i class="fa fa-heartbeat me-2" title="Health Icon"/>
                                <strong>Medical Overview:</strong>
                                Complete medical history and health status for this pet.
                            </div>
                        </div>
                    </div>

                    <group>
                        <group string="Current Status">
                            <field name="ths_deceased" readonly="1"/>
                            <field name="ths_deceased_date" readonly="1" invisible="not ths_deceased"/>
                            <field name="is_neutered_spayed" readonly="1"/>
                        </group>
                        <group string="Identification">
                            <field name="ths_microchip" readonly="1"/>
                            <field name="ths_insurance_number" readonly="1"/>
                            <field name="ths_emergency_contact" readonly="1"/>
                        </group>
                    </group>

                    <!-- TODO: Add vaccination history, last checkup, etc. -->
                    <div class="mt-3">
                        <h5>Vaccination History</h5>
                        <p class="text-muted">Vaccination tracking will be available in future updates.</p>

                        <h5>Recent Encounters</h5>
                        <p class="text-muted">Use the "Medical History" button above to view complete encounter
                            history.</p>
                    </div>
                </page>

            </xpath>

        </field>
    </record>

    <!-- Enhanced List View -->
    <record id="view_partner_list_inherit_ths_vet" model="ir.ui.view">
        <field name="name">res.partner.list.inherit.ths.vet</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">

            <!-- Add computed flags -->
            <xpath expr="//list" position="inside">
                <field name="is_pet" column_invisible="1"/>
                <field name="is_pet_owner" column_invisible="1"/>
            </xpath>

            <!-- Add vet-specific columns -->
            <xpath expr="//field[@name='ths_partner_type_id']" position="after">
                <field name="ths_pet_owner_id"
                       optional="hide"
                       string="Pet Owner"
                       invisible="not is_pet"/>
                <field name="ths_species_id"
                       optional="show"
                       string="Species"
                       invisible="not is_pet"/>
                <field name="ths_breed_id"
                       optional="hide"
                       string="Breed"
                       invisible="not is_pet"/>
                <field name="ths_microchip"
                       optional="hide"
                       string="Microchip"
                       invisible="not is_pet"/>
                <field name="ths_pet_count"
                       optional="show"
                       string="# Pets"
                       invisible="not is_pet_owner"/>
                <field name="ths_deceased"
                       optional="hide"
                       widget="boolean_toggle"
                       string="Deceased"
                       invisible="not is_pet"/>
            </xpath>

            <!-- Add color coding -->
            <xpath expr="//list" position="attributes">
                <attribute name="decoration-muted">ths_deceased == True</attribute>
                <attribute name="decoration-primary">is_pet_owner == True</attribute>
                <attribute name="decoration-info">is_pet == True and ths_deceased == False</attribute>
            </xpath>

        </field>
    </record>

    <!-- Enhanced Search/Filter View -->
    <record id="view_res_partner_filter_inherit_ths_vet" model="ir.ui.view">
        <field name="name">res.partner.filter.inherit.ths.vet</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="ths_base.view_res_partner_filter_inherit_ths_base"/>
        <field name="arch" type="xml">

            <!-- Add vet-specific search fields -->
            <xpath expr="//field[@name='ths_partner_type_id']" position="after">
                <field name="ths_pet_owner_id" string="Pet Owner"/>
                <field name="ths_species_id" string="Species"/>
                <field name="ths_breed_id" string="Breed"/>
                <field name="ths_microchip" string="Microchip"/>
                <field name="ths_insurance_number" string="Insurance"/>
            </xpath>

            <!-- Add vet-specific filters -->
            <xpath expr="//filter[@name='filter_partner_type']" position="before">

                <!-- Quick Type Filters -->
                <filter string="Active Pets"
                        name="filter_active_pets"
                        domain="[('ths_partner_type_id.name', '=', 'Pet'), ('ths_deceased', '=', False)]"/>
                <filter string="Pet Owners"
                        name="filter_pet_owners"
                        domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"/>
                <filter string="Deceased Pets"
                        name="filter_deceased_pets"
                        domain="[('ths_partner_type_id.name', '=', 'Pet'), ('ths_deceased', '=', True)]"/>

                <!-- Species Filters -->
                <separator/>
                <filter string="Dogs"
                        name="filter_dogs"
                        domain="[('ths_species_id.name', 'ilike', 'dog')]"/>
                <filter string="Cats"
                        name="filter_cats"
                        domain="[('ths_species_id.name', 'ilike', 'cat')]"/>

                <!-- Health Status Filters -->
                <separator/>
                <filter string="Spayed/Neutered"
                        name="filter_neutered"
                        domain="[('is_neutered_spayed', '=', True)]"/>
                <filter string="With Microchip"
                        name="filter_microchip"
                        domain="[('ths_microchip', '!=', False)]"/>
                <filter string="With Insurance"
                        name="filter_insurance"
                        domain="[('ths_insurance_number', '!=', False)]"/>

                <separator/>
            </xpath>

            <!-- Add vet-specific group by options -->
            <xpath expr="//group[@expand='0']" position="inside">
                <filter string="Pet Owner"
                        name="groupby_pet_owner"
                        context="{'group_by': 'ths_pet_owner_id'}"/>
                <filter string="Species"
                        name="groupby_species"
                        context="{'group_by': 'ths_species_id'}"/>
                <filter string="Breed"
                        name="groupby_breed"
                        context="{'group_by': 'ths_breed_id'}"/>
                <filter string="Health Status"
                        name="groupby_health"
                        context="{'group_by': 'ths_deceased'}"/>
            </xpath>

        </field>
    </record>

    <!-- Enhanced Kanban View -->
    <record id="view_partner_kanban_inherit_ths_vet" model="ir.ui.view">
        <field name="name">res.partner.kanban.inherit.ths.vet</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.res_partner_kanban_view"/>
        <field name="arch" type="xml">

            <!-- Add computed fields for kanban -->
            <xpath expr="//field[@name='active']" position="after">
                <field name="is_pet"/>
                <field name="is_pet_owner"/>
                <field name="ths_deceased"/>
                <field name="ths_species_id"/>
                <field name="ths_pet_owner_id"/>
                <field name="ths_pet_count"/>
            </xpath>

            <!-- Customize avatar for pets -->
            <xpath expr='//div[hasclass("o_kanban_image_fill")]' position="replace">
                <div class="o_kanban_image_fill position-relative">
                    <!-- Pet Avatar -->
                    <t t-if="record.is_pet.raw_value">
                        <div class="d-flex align-items-center justify-content-center h-100"
                             t-att-class="record.ths_deceased.raw_value ? 'bg-light' : 'bg-primary'"
                             style="border-radius: 50%;">
                            <i t-att-class="'fa fa-paw fa-3x ' + (record.ths_deceased.raw_value ? 'text-muted' : 'text-white')"
                               title="Pet Avatar"/>
                        </div>
                        <!-- Deceased indicator -->
                        <div t-if="record.ths_deceased.raw_value"
                             class="position-absolute top-0 end-0 badge bg-dark">
                            <i class="fa fa-angel" title="Deceased"/>
                        </div>
                    </t>

                    <!-- Standard avatar for non-pets -->
                    <t t-else="">
                        <field name="avatar_128" widget="image" class="h-100 w-100 object-fit-cover"/>
                    </t>
                </div>
            </xpath>

            <!-- Add pet-specific info to kanban card -->
            <xpath expr="//templates//main//div[hasclass('mb-1')]" position="inside">
                <!-- Pet Information -->
                <div t-if="record.is_pet.raw_value" class="text-muted small mt-1">
                    <div t-if="record.ths_species_id.raw_value">
                        <i class="fa fa-tag me-1" title="Species"/>
                        <field name="ths_species_id"/>
                    </div>
<!--                    <div t-if="record.ths_pet_owner_id.raw_value">-->
<!--                        <i class="fa fa-user me-1" title="Owner"/>-->
<!--                        Owner: <field name="ths_pet_owner_id"/>-->
<!--                    </div>-->
                </div>

                <!-- Pet Owner Information -->
                <div t-if="record.is_pet_owner.raw_value" class="text-muted small mt-1">
                    <div t-if="record.ths_pet_count.raw_value">
                        <i class="fa fa-paw me-1" title="Number of Pets"/>
                        <field name="ths_pet_count"/> pets
                    </div>
                </div>
            </xpath>

        </field>
    </record>

    <!-- Pet-specific Actions -->
    <record id="action_view_partner_pets" model="ir.actions.act_window">
        <field name="name">Pets</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('ths_partner_type_id.name', '=', 'Pet')]</field>
        <field name="context">{'search_default_filter_active_pets': 1, 'default_ths_partner_type_id': 'Pet',
                               'show_pet_owner': True}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No pets found!
            </p>
            <p>
                Create the first pet record to start managing veterinary care.
            </p>
        </field>
    </record>

    <!-- Pet Owner-specific Action -->
    <record id="action_view_partner_pet_owners" model="ir.actions.act_window">
        <field name="name">Pet Owners</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('ths_partner_type_id.name', '=', 'Pet Owner')]</field>
        <field name="context">{'search_default_filter_pet_owners': 1,
                               'default_ths_partner_type_id': 'Pet Owner'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No pet owners found!
            </p>
            <p>
                Create the first pet owner record to start managing veterinary customers.
            </p>
        </field>
    </record>
</odoo>
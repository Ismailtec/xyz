<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Vet-specific Medical Encounter Form View -->
    <record id="view_ths_medical_encounter_form_inherit_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.form.inherit.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_form"/>
        <field name="arch" type="xml">

            <!-- Replace patient information section with vet workflow -->
            <!--            <xpath expr="//group[@name='encounter_patient_info']" position="replace">-->
            <!--                <group string="Veterinary Information" name="vet_encounter_info" col="2">-->
            <!--                    <group name="vet_col_1">-->
            <!--                        <field name="ths_pet_owner_id" string="Pet Owner (Billing)"-->
            <!--                               domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"-->
            <!--                               options="{'no_create': True, 'no_quick_create': True}"-->
            <!--                               placeholder="Select pet owner for billing..."-->
            <!--                               help="Pet owner responsible for billing and medical decisions"/>-->

            <!--                        <field name="patient_ids" string="Pets (Patients)"-->
            <!--                               widget="many2many_tags"-->
            <!--                               domain="patient_ids_domain"-->
            <!--                               context="{'default_ths_partner_type_id': %(ths_medical_vet.partner_type_pet)d}"-->
            <!--                               options="{'no_create': True, 'no_quick_create': True}"-->
            <!--                               placeholder="Select pets receiving care..."-->
            <!--                               help="Pets receiving veterinary care in this encounter"/>-->

            <!--                        <field name="patient_ids_domain" invisible="1"/>-->

            <!--                        <field name="practitioner_id" string="Veterinarian"-->
            <!--                               domain="[('ths_is_medical', '=', True)]"-->
            <!--                               options="{'no_create': True, 'no_quick_create': True}"-->
            <!--                               help="Veterinarian providing the care"/>-->
            <!--                    </group>-->

            <!--                    <group name="vet_col_2">-->
            <!--                        <field name="partner_id" string="Billing Customer" readonly="1"-->
            <!--                               domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"-->
            <!--                               help="Billing customer (automatically synced with Pet Owner)"/>-->
            <!--                        <field name="appointment_id" readonly="1" options="{'no_open': True}"/>-->
            <!--                        <field name="date_start" string="Start Date/Time"/>-->
            <!--                        <field name="date_end" string="End Date/Time"/>-->
            <!--                    </group>-->
            <!--                </group>-->
            <!--            </xpath>-->
            <xpath expr="//group[@name='encounter_patient_info']/group/field[@name='partner_id']" position="replace">
                <field name="partner_id"
                       string="Billing Customer"
                       domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"
                       help="Billing customer (automatically synced with Pet Owner)"/>
            </xpath>

            <xpath expr="//group[@name='encounter_patient_info']/group/field[@name='patient_ids']" position="replace">
                <field name="patient_ids" string="Pets (Patients)"
                       widget="many2many_tags"
                       options="{'no_create': True, 'no_quick_create': True}"
                       context="{'default_ths_partner_type_id': %(ths_medical_vet.partner_type_pet)d}"
                       domain="patient_ids_domain"
                       placeholder="Select pets receiving care..."
                       help="Pets receiving veterinary care in this encounter"/>
            </xpath>

            <xpath expr="//group[@name='encounter_patient_info']/group/field[@name='practitioner_id']"
                   position="replace">
                <field name="practitioner_id" string="Veterinarian"
                       domain="[('ths_is_medical', '=', True)]"
                       options="{'no_create': True, 'no_quick_create': True}"
                       help="Veterinarian providing the care"/>
            </xpath>

            <xpath expr="//group[@name='encounter_patient_info']/group" position="after">
                <group>
                    <field name="ths_pet_owner_id" string="Pet Owner (Billing)"
                           options="{'no_create': True, 'no_quick_create': True}"
                           domain="[('ths_partner_type_id.name', '=', 'Pet Owner')]"
                           placeholder="Select pet owner for billing..."
                           help="Pet owner responsible for billing and medical decisions"/>
                </group>
            </xpath>


            <!-- Add vet-specific encounter actions -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_pet_medical_histories"
                        icon="fa-paw"
                        invisible="not patient_ids">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Pet Medical</span>
                        <span class="o_stat_text">Histories</span>
                    </div>
                </button>

                <button class="oe_stat_button" type="object" name="action_create_pending_items_for_all_pets"
                        icon="fa-shopping-cart"
                        invisible="not patient_ids or state != 'in_progress'">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Create Pending</span>
                        <span class="o_stat_text">Items</span>
                    </div>
                </button>
            </xpath>


            <!-- Add vet-specific clinical fields -->
            <xpath expr="//field[@name='chief_complaint']" position="after">
                <!-- Add quick pet summary -->
                <field name="patient_ids" invisible="1"/>
                <div class="alert alert-info" invisible="not patient_ids">
                    <strong>Pets in this encounter:</strong>
                    <ul>
                        <li><field name="patient_ids" widget="many2many_tags" readonly="1"/></li>
                    </ul>
                </div>
            </xpath>

        </field>
    </record>

    <!-- Vet-specific Medical Encounter List View -->
    <record id="view_ths_medical_encounter_list_inherit_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.list.inherit.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_list"/>
        <field name="arch" type="xml">

            <!-- Update field labels for vet context -->
            <xpath expr="//field[@name='patient_ids']" position="attributes">
                <attribute name="string">Pets</attribute>
                <attribute name="widget">many2many_tags</attribute>
            </xpath>

            <!-- Add pet owner field -->
            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="ths_pet_owner_id" optional="show" string="Pet Owner"/>
            </xpath>

            <!-- Update partner_id label -->
            <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="string">Billing Customer</attribute>
                <attribute name="optional">hide</attribute>
            </xpath>

        </field>
    </record>

    <!-- Vet-specific Medical Encounter Search View -->
    <record id="view_ths_medical_encounter_search_inherit_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.search.inherit.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_search"/>
        <field name="arch" type="xml">

            <!-- Update field labels and add pet owner search -->
            <xpath expr="//field[@name='patient_ids']" position="attributes">
                <attribute name="string">Pets</attribute>
            </xpath>

            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="ths_pet_owner_id" string="Pet Owner"/>
            </xpath>

            <!-- Add vet-specific filters -->
            <xpath expr="//filter[@name='filter_ready_billing']" position="after">
                <separator/>
                <filter string="Multi-Pet Encounters" name="filter_multi_pet"
                        domain="[('patient_ids', '!=', False)]"
                        help="Encounters with multiple pets"/>
                <filter string="Single Pet Encounters" name="filter_single_pet"
                        domain="[('patient_ids', '!=', False)]"
                        help="Encounters with single pet"/>
            </xpath>

            <!-- Add vet-specific group by options -->
            <xpath expr="//filter[@name='groupby_practitioner']" position="after">
                <filter string="Pet Owner" name="groupby_pet_owner"
                        context="{'group_by': 'ths_pet_owner_id'}"/>
<!--                <filter string="Pet Species" name="groupby_species"-->
<!--                        context="{'group_by': 'patient_ids.ths_species'}"/>-->
            </xpath>

        </field>
    </record>

    <!-- Create vet-specific encounter action -->
    <record id="action_ths_medical_encounter_vet" model="ir.actions.act_window">
        <field name="name">Veterinary Encounters</field>
        <field name="res_model">ths.medical.base.encounter</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="domain">[('patient_ids.ths_partner_type_id.name', '=', 'Pet')]</field>
        <field name="context">{'search_default_filter_in_progress': 1, 'default_practitioner_required': True}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No veterinary encounters found
            </p>
            <p>
                Create your first veterinary encounter to start tracking pet medical care.
            </p>
        </field>
    </record>

</odoo>
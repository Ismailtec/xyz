<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_ths_medical_encounter_form_inherit_ths_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.form.inherit.ths.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_form"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='patient_ids']" position="attributes">
                <attribute name="string">Pets</attribute>
                <attribute name="widget">many2many_tags</attribute>
            </xpath>
            <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="string">Pet Owner</attribute>
            </xpath>

            <!-- Add pets summary and count after patient_ids -->
            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="total_pets_count" readonly="1" string="Total Pets"/>
                <field name="pets_summary" readonly="1" string="Pets Summary"
                       invisible="total_pets_count &lt;= 1"/>
            </xpath>

            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="ths_species" readonly="1" string="Pet Species"
                       invisible="total_pets_count == 0"/>
                <field name="ths_breed" readonly="1" string="Pet Breed"
                       invisible="total_pets_count == 0"/>
                <field name="ths_pet_age" readonly="1" string="Pet Age"
                       invisible="total_pets_count == 0"/>
                <field name="ths_pet_gender" readonly="1" string="Pet Gender"
                       invisible="total_pets_count == 0"/>
            </xpath>

        </field>
    </record>


    <record id="view_ths_medical_encounter_list_inherit_ths_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.list.inherit.ths.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_list"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='patient_ids']" position="attributes">
                <attribute name="string">Pets</attribute>
                <attribute name="domain">[('ths_partner_type_id.name', '=', 'Pet')]</attribute>
                <attribute name="context">{'default_ths_partner_type_id':
                    %(ths_medical_vet.partner_type_pet)d}</attribute>
                <attribute name="widget">many2many_tags</attribute>
                <attribute name="options">{'no_create': True, 'no_quick_create': True}</attribute>
                <attribute name="placeholder">Select pets...</attribute>
            </xpath>
            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="partner_id" string="Pet Owner" optional="show"/>
                <field name="total_pets_count" string="# Pets" optional="hide"/>
            </xpath>
        </field>
    </record>


    <record id="view_ths_medical_encounter_search_inherit_ths_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.search.inherit.ths.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_search"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="string">Owner Pet</attribute>
                <attribute name="filter_domain">['|', '|', ('partner_id', 'ilike', self), ('patient_id', 'ilike', self),
                                                 ('patient_id.ref', 'ilike', self)]</attribute>
            </xpath>
            <xpath expr="//field[@name='patient_ids']" position="attributes">
                <attribute name="string">Pets</attribute>
            </xpath>
            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="partner_id" string="Pet Owner"/>
                <field name="ths_species" string="Species"/>
                <field name="ths_breed" string="Breed"/>
            </xpath>
            <xpath expr="//filter[@name='groupby_patient']" position="attributes">
                <attribute name="string">Pets</attribute>
            </xpath>
            <xpath expr="//filter[@name='groupby_patient']" position="before">
                <filter string="Pet Owner" name="groupby_owner" context="{'group_by': 'partner_id'}"/>
                <filter string="Species" name="groupby_species" context="{'group_by': 'ths_species'}"/>
            </xpath>

        </field>
    </record>

    <!-- Kanban view for better visual representation of multiple pets -->
    <record id="view_ths_medical_encounter_kanban_inherit_ths_vet" model="ir.ui.view">
        <field name="name">ths.medical.base.encounter.kanban.inherit.ths.vet</field>
        <field name="model">ths.medical.base.encounter</field>
        <field name="inherit_id" ref="ths_medical_base.view_ths_medical_encounter_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='patient_ids']" position="after">
                <field name="total_pets_count"/>
                <field name="pets_summary"/>
                <field name="ths_species"/>
            </xpath>
            <xpath expr="//div[@class='o_kanban_record_body']" position="replace">
                <div class="o_kanban_record_body">
                    <!-- Show pets summary instead of single patient -->
                    <div class="row">
                        <div class="col-12">
                            <strong t-if="record.total_pets_count.raw_value == 1">
                                <t t-esc="record.pets_summary.value"/>
                            </strong>
                            <strong t-elif="record.total_pets_count.raw_value > 1">
                                <t t-esc="record.total_pets_count.value"/> Pets:
                                <t t-esc="record.pets_summary.value"/>
                            </strong>
                            <span t-else="" class="text-muted">No pets assigned</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <field name="partner_id"/> <!-- Pet Owner -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <field name="practitioner_id"/>
                        </div>
                    </div>
                    <div class="row" t-if="record.ths_species.value">
                        <div class="col-12">
                            <small class="text-muted">
                                <t t-esc="record.ths_species.value"/>
                            </small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <t t-esc="record.date_start.value"/>
                            </small>
                        </div>
                    </div>
                </div>
            </xpath>
        </field>
    </record>

</odoo>